<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>Authorize.Net Accept.js Sandbox</title>

  <!-- Accept.js SANDBOX -->
  <script
    type="text/javascript"
    src="https://jstest.authorize.net/v1/Accept.js"
    charset="utf-8">
  </script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .section {
      border: 1px solid #ddd;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    label {
      display: inline-block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 300px;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    pre {
      background-color: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
  </style>
</head>

<body>
  <h3>Accept.js Sandbox Token Generator</h3>

  <form id="paymentForm">
    <label>
      Card Number
      <input type="text" id="cardNumber" value="4111111111111111" />
    </label>
    <br/><br/>

    <label>
      Expiry (MMYY)
      <input type="text" id="exp" value="1227" />
    </label>
    <br/><br/>

    <label>
      CVV
      <input type="text" id="cvv" value="123" />
    </label>
    <br/><br/>

    <button type="submit">Generate Token</button>
  </form>

  <pre id="output"></pre>

  <!-- Section 2: Create Subscription -->
  <div class="section">
    <h3>2. Create Subscription</h3>
    
    <form id="subscriptionForm">
      <label>
        Customer ID
        <input type="text" id="customerId" value="customerId9" placeholder="Enter customer ID" />
      </label>
      <br/><br/>

      <label>
        Merchant Subscription ID
        <input type="text" id="merchantSubscriptionId" value="SUB-6" placeholder="Enter subscription ID" />
      </label>
      <br/><br/>

      <label>
        Payment Method Token (dataValue from above)
        <input type="text" id="paymentToken" placeholder="Paste token from above" />
      </label>
      <br/><br/>

      <button type="submit" id="createSubscriptionBtn">Create Subscription</button>
    </form>

    <h4>Request:</h4>
    <pre id="subscriptionRequest">Request will appear here...</pre>

    <h4>Response:</h4>
    <pre id="subscriptionOutput">Response will appear here...</pre>

    <h4>cURL Command:</h4>
    <pre id="subscriptionCurl">cURL command will appear here...</pre>
  </div>

  <script>
    const authData = {
      clientKey: "2Q98dLVCm4r2skVUpQJhDWtz836Be37C4q7cx5Rj3Z7Pw3Ug6AKfgu5DLrdR5hnY",
      apiLoginID: "5YMD3vK4jad"
    };

    // Generate UUID for idempotency key
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    document.getElementById("paymentForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const cardData = {
        cardNumber: document.getElementById("cardNumber").value,
        month: document.getElementById("exp").value.substring(0, 2),
        year: document.getElementById("exp").value.substring(2, 4),
        cardCode: document.getElementById("cvv").value
      };

      const secureData = {
        authData: authData,
        cardData: cardData
      };

      Accept.dispatchData(secureData, responseHandler);
    });

    function responseHandler(response) {
      const output = document.getElementById("output");

      if (response.messages.resultCode === "Error") {
        output.textContent = JSON.stringify(response, null, 2);
        return;
      }

      output.textContent = JSON.stringify({
        dataDescriptor: response.opaqueData.dataDescriptor,
        dataValue: response.opaqueData.dataValue
      }, null, 2);
      
      // Auto-fill payment token
      if (response.opaqueData && response.opaqueData.dataValue) {
        document.getElementById("paymentToken").value = response.opaqueData.dataValue;
      }
    }

    // Create Subscription Form Handler
    document.getElementById("subscriptionForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const customerId = document.getElementById("customerId").value.trim();
      const merchantSubscriptionId = document.getElementById("merchantSubscriptionId").value.trim();
      const paymentToken = document.getElementById("paymentToken").value.trim();

      if (!customerId || !merchantSubscriptionId || !paymentToken) {
        document.getElementById("subscriptionOutput").textContent = "Error: All fields are required!";
        document.getElementById("subscriptionOutput").className = "error";
        return;
      }

      // Generate idempotency key
      const idempotencyKey = generateUUID();

      // Get current date and 1 year from now for dates
      const startDate = new Date().toISOString();
      const endDate = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString();

      const requestBody = {
        customerId: customerId,
        merchantSubscriptionId: merchantSubscriptionId,
        amount: {
          amount: 100.5,
          currency: "USD",
          currencyCode: "string",
          amountCents: 0,
          amountAsString: "string"
        },
        interval: "MONTHLY",
        intervalCount: 1,
        paymentMethodToken: paymentToken,
        gateway: "AUTHORIZE_NET",
        description: "Monthly premium subscription",
        startDate: startDate,
        endDate: endDate,
        maxBillingCycles: 10
      };

      // Display the request body
      document.getElementById("subscriptionRequest").textContent = JSON.stringify(requestBody, null, 2);

      // Generate cURL command
      const curlCmd = `curl -X 'POST' \\
  'http://localhost:8080/v1/subscriptions' \\
  -H 'accept: */*' \\
  -H 'Idempotency-Key: ${idempotencyKey}' \\
  -H 'Content-Type: application/json' \\
  -d '${JSON.stringify(requestBody, null, 2)}'`;
      
      document.getElementById("subscriptionCurl").textContent = curlCmd;

      // Disable button during request
      const btn = document.getElementById("createSubscriptionBtn");
      btn.disabled = true;
      btn.textContent = "Creating...";

      try {
        const response = await fetch("http://localhost:8080/v1/subscriptions", {
          method: "POST",
          mode: "cors",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            "Accept": "*/*",
            "Idempotency-Key": idempotencyKey
          },
          body: JSON.stringify(requestBody)
        });

        const responseData = await response.json();
        
        document.getElementById("subscriptionOutput").textContent = JSON.stringify({
          status: response.status,
          statusText: response.statusText,
          data: responseData
        }, null, 2);

        if (response.ok) {
          document.getElementById("subscriptionOutput").className = "success";
        } else {
          document.getElementById("subscriptionOutput").className = "error";
        }
      } catch (error) {
        document.getElementById("subscriptionOutput").textContent = `Error: ${error.message}\n\nTroubleshooting:\n1. Ensure Spring Boot app is running on port 8080\n2. Check browser console for detailed error\n3. Try accessing http://localhost:8080/actuator/health directly`;
        document.getElementById("subscriptionOutput").className = "error";
      } finally {
        btn.disabled = false;
        btn.textContent = "Create Subscription";
      }
    });
  </script>
</body>
</html>
